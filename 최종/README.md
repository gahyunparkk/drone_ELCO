2024 미니드론 자율비행 경진대회
===============

2024 미니드론 자율비행 경진대회 기술 워크샵
- 주최 : 대한전기학회
- 팀명 : ELCO

(사진 1 : 강의실 사진)

## 0. 목차

1. 개요
2. 대회 진행 전략
3. 알고리즘 및 소스 코드 설명
4. 시도한 알고리즘

## 1. 개요

### 1.1. 경로 상세 규격

(사진 2 : 경로 사진)

- 가림막 링
  - 1차 링 지름 : 57 cm
  - 2차 링 지름 : 46 cm
  - 3차 링 지름 : 46 cm
  - 4차 링 지름 : 52 cm
  - 링 중심의 높이 : 80 ~ 100 cm
 
- 색상 hsv 의 h 범위
  - 빨간색 색상 마크 : 0 ~ 0.07
  - 초록색 색상 마크 : 0.24 ~ 0.34
  - 보라색 색상 마크 : 0.70 ~ 0.79
  - 파란색 가림막 : 0.55 ~ 0.75

### 1.2. 사용한 Toolbox

- image processing toolbox

## 2. 대회 진행 전략

### 2.1. 드론이 링과 링 너머 색상 마크의 중심에 위치하도록 조정

드론이 링과 링 너머 색상 마크의 중심에 위치하도록 조정한 후 드론이 앞으로 이동하도록 했다. 이를 수행하기 위한 알고리즘은 아래와 같다.

- 드론이 링 너머 색상 마크의 중심에 위치하도록 조정했다. 색상 마크의 중심 좌표를 return 하는 square_detect 함수와 드론이 색상 마크 또는 링의 중심에 위치하도록 하는 move_to_center 함수를 이용했다.
  - 드론이 색상 마크를 인식하지 못하는 경우 드론이 링의 중심에 위치하도록 조정했다. 링의 중심 좌표를 return 하는 detect_from_frame 함수와 move_to_center 함수를 이용했다.
    - 드론이 링을 인식하지 못하는 경우 드론이 링을 인식할 때까지 드론을 20 cm 씩 뒤로 이동시켰다.
      
- 드론이 색상 마크의 중심에 위치하면 색상 마크의 중심, 즉 드론의 위치와 링의 중심을 비교한다. 드론의 위치와 링의 중심의 차이가 100 보다 작은 경우 드론이 링과 색상 마크의 중심에 위치했다고 판단한다.
   - 드론의 위치와 링의 중심의 차이가 100 보다 큰 경우 드론이 링의 중심에 위치하도록 조정했다.
 
### 2.2. 오차를 증가시키면서 드론을 이동

드론이 이동할 수 있는 최소 거리는 20 cm 이다. 드론이 위치해야 하는 곳에 정확히 위치하기 위해 계속해서 상하 또는 좌우로 이동하는 문제가 발생했다. 위의 문제를 해결하고, 드론이 링 또는 색상 마크의 중심으로 이동하는 데 걸리는 시간을 최소화하기 위해 오차와 관련된 변수를 설정하고, 오차를 증가시키면서 드론을 이동시켰다.

- 드론의 위치와 링 또는 색상 마크의 중심 사이의 오차가 무시할 수 있을 만큼 작으면 드론이 링 또는 색상 마크의 중심에 위치한 것으로 판단했다. 이를 통해 드론이 링 또는 색상 마크의 중심으로 이동하는 데 걸리는 시간을 최소화했다.
- 드론이 이동할 때마다 오차를 증가시켰다. 이를 통해 드론이 위치해야 하는 곳에 정확히 위치하기 위해 계속해서 상하 또는 좌우로 이동하는 문제를 해결했다.

### 2.3. 드론 카메라 중심의 y 좌표를 360 이 아닌 200 으로 설정

드론 카메라 frame 의 x 좌표는 0 ~ 960, y 좌표는 0 ~ 720 이다. 드론 카메라 중심의 y 좌표를 360 으로 설정하면 드론이 위치해야 하는 곳에 비해 위쪽에 위치하는 문제가 발생했다. 드론 카메라가 정확히 정면이 아닌 약간 아래쪽을 향하기 때문이다.

- 드론을 위로 조금씩 이동시키면서 드론이 위치해야 하는 곳에 정확히 위치하도록 하는 y 좌표를 찾았다. moveup 함수를 이용하여 드론을 위쪽으로 20 cm 씩 이동시키고 imshow 함수를 이용하여 이미지를 표시했다. 위의 과정을 통해 드론 카메라 중심의 y 좌표를 200 으로 설정하면 드론이 위치해야 하는 곳에 정확히 위치함을 알게 되었다.

### 2.4. 4 단계 링을 통과하기 전 y 좌표를 비교하는 과정을 생략

드론이 주행하는 시간을 최소화하기 위해 4 단계 링을 통과하기 전 드론 카메라 중심과 링 너머 색상 마크의 중심의 y 좌표를 비교하는 과정을 생략했다.

- 위의 과정은 드론이 착륙 지점에 정확히 착지하도록 하기 위한 것이기 때문에 y 좌표를 비교하는 과정은 필수적이지 않은 것으로 판단했다.
 
## 3. 알고리즘 및 소스 코드 설명

* 드론 설정

   drone 변수 생성 및 중심 기준 선언
   
   cameraObj 변수 생성
   
   오차범위 dif = 40 선언
   
```
clear;
drone = ryze('Tello');

takeoff(drone);
pause(1);

% 드론 카메라 중심의 y 값을 200 으로 설정
center_point = [480, 200];
cameraObj = camera(drone);
dif = 40; 
```
   
* 1단계[링 통과]

   squzre_detect 함수 사용하면서 빨간색 정사각형의 x, y축 찾기
   
   move_to_center 함수 사용하면서 드론의 위치 조정
   
   오차범위(시작할때 55, 한번 위치 조정할 때마다 15씩 증가) 안에 들어올때까지 무한반복
   
   만약 정사각형이 인식되지 않으면 오류메세지 출력 후 앞으로 이동
   
```
while true
    frame = snapshot(cameraObj);
    dif = dif + 15;

    [x, y] = square_detect(frame, 0, 0.07);
    move_to_center(drone, x, y, dif);
    if isnan(x) || isnan(y)
        disp('No red square detected.');
        break;
    end
 
    centroid = [x, y];
    dis = centroid - center_point;

    if abs(dis(1)) <= dif && abs(dis(2)) <= dif
        disp('Centered successfully!');
        break;
    end
end
```
  
* 2단계[130도 시계방향 회전 및 초록색 정사각형 중심 찾기]
* 3단계[130도 반시계방향 회전 및 보라색 정사각형 중심 찾기]
* 4단계[215도 시계방향 회전 및 링 중심 찾기]
* 5단계[빨간색 정사각형 중심 찾기 맟 착륙]
* 함수 detect_from_frame
* 함수 move_to_center
* 함수 square_detect


## 4. 시도한 알고리즘

1. 0.6m 씩 갔는데 너무 오래걸림
2. 1단계에서 링 중심 잡았는데 시간 오래걸림
3. 4단계 링 중심 잡을때 화면 비율 했는데 항상 잘 잡혀서 걍 뺌

* 파란색 천막의 중심 계산 및 드론 제어:
   * 3단계 회전 후, 4단계 경로를 이동하기 전, 천막의 중심을 찾아서 드론의 위치를 고정해준 다음, 이동하게 한다.
   * 만약 천막이 감지되지 않으면 "No bounding box" 문구를 출력하면서 이동을 한다.
   * 화면의 잡히는 천막의 비율을 비교해서, 만약 인식되는 천막이 너무 작으면 "Bounding box too small" 문구 출력 후, 이동한다.

4. 중심 잡을때 오차값 말고 드론 이동 거리를 줄였는데, 최소 이동 가능 거리가 0.2m라 대안으로 오차값을 증가시킴
